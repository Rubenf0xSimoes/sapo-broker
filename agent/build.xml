<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="build" name="sapo-broker-agent">
	<property name="project.location" value="." />
	<property name="dist" value="dist" />
	<property name="src" value="src" />
	<property name="bin" value="bin" />
	<property name="target-dir" value="../sapo-broker" />
	<property name="package" value="sapo-broker-agent.jar" />

	<path id="project.classpath">
		<pathelement location="../comm-types/dist/sapo-broker-commtypes.jar" />
		<pathelement location="../gcs/dist/sapo-gcs.jar" />
		<pathelement location="../bindings/xml/java/dist/sapo-broker-xmlbinding.jar" />
		<pathelement location="../bindings/protobuf/java/dist/sapo-broker-protobufbinding.jar" />
		<pathelement location="../bindings/thrift/java/dist/sapo-broker-thriftbinding.jar" />
		<fileset dir="../common-libs/">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<target name="init" depends="clean">
		<mkdir dir="${bin}" />
		<mkdir dir="${dist}" />
	</target>

	<target name="clean">
		<delete dir="${bin}" />
		<delete dir="${dist}" />
		<delete dir="${target-dir}" />
		<delete file="../sapo-broker.tar.gz" />
	</target>

	<target name="clean-all" depends="clean">
		<ant antfile="../comm-types/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../gcs/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../bindings/xml/java/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../bindings/protobuf/java/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../bindings/thrift/java/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../clients/java-Component-BrokerTCP/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../sapo-sts/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../database-access-control/build.xml" inheritAll="false" target="clean" />
		<ant antfile="../broker-tests/build.xml" inheritAll="false" target="clean" />
	</target>

	<target name="build" depends="init, package-all">
		<echo message="${ant.project.name}: ${ant.file}" />
		<tstamp/>
		
		<copy file="src/pt/com/broker/core/BrokerInfo.java" tofile="src/pt/com/broker/core/BrokerInfo.bak" overwrite="true"/>
		<replace file="src/pt/com/broker/core/BrokerInfo.java" token="@brokerVersion@" value="${DSTAMP}${TSTAMP}"/>
		<javac destdir="bin" encoding="UTF-8" debug="on" debuglevel="lines,vars,source" source="1.5" target="1.5">
			<src path="src" />
			<classpath refid="project.classpath" />
		</javac>
		<move file="src/pt/com/broker/core/BrokerInfo.bak" tofile="src/pt/com/broker/core/BrokerInfo.java" overwrite="true"/>
		<copy todir="bin">
			<fileset dir="src" excludes="**/*.java"/>
		</copy>
	</target>

	<target name="package" depends="build">
		<jar destfile="${dist}/${package}">
			<fileset dir="${bin}" />
		</jar>
	</target>

	<target name="package-all">
		<ant antfile="../comm-types/build.xml" inheritAll="false" target="package" />
		<ant antfile="../gcs/build.xml" inheritAll="false" target="package" />
		<ant antfile="../bindings/xml/java/build.xml" inheritAll="false" target="package">
			<property name="project.location" value="../bindings/xml/java"/> 
		</ant>
		<ant antfile="../acl/sapo-sts/build.xml" inheritAll="false" target="package" />
		<ant antfile="../acl/jdbc/build.xml" inheritAll="false" target="package" />
		<ant antfile="../bindings/protobuf/java/build.xml" inheritAll="false" target="package" />
		<ant antfile="../bindings/thrift/java/build.xml" inheritAll="false" target="package" />
		<ant antfile="../clients/java-Component-BrokerTCP/build.xml" inheritAll="false" target="package" />
		<ant antfile="../broker-tests/build.xml" inheritAll="false" target="package" />
	</target>

	<target name="build-dist" depends="package, package-all">

		<mkdir dir="${target-dir}/lib" />
		
		<copy todir="${target-dir}/lib">
			<fileset dir="${project.location}/../common-libs/">
				<include name="*.jar"/>
			</fileset>
 		</copy>
		<copy file="./dist/sapo-broker-agent.jar" todir="${target-dir}/lib" />
		<copy file="../comm-types/dist/sapo-broker-commtypes.jar" todir="${target-dir}/lib" />
		<copy file="../gcs/dist/sapo-gcs.jar" todir="${target-dir}/lib" />
		<copy file="../bindings/xml/java/dist/sapo-broker-xmlbinding.jar" todir="${target-dir}/lib" />
		<copy file="../bindings/protobuf/java/dist/sapo-broker-protobufbinding.jar" todir="${target-dir}/lib" />
		<copy file="../bindings/thrift/java/dist/sapo-broker-thriftbinding.jar" todir="${target-dir}/lib" />
		<copy file="../clients/java-Component-BrokerTCP/dist/java-Component-BrokerTCP.jar" todir="${target-dir}/lib" />
		<copy file="../acl/sapo-sts/dist/sapo-broker-auth-saposts.jar" todir="${target-dir}/lib" />
		<copy file="../acl/jdbc/dist/sapo-broker-auth-jdbc.jar" todir="${target-dir}/lib" />
		<copy file="../broker-tests/dist/sapo-broker-tests.jar" todir="${target-dir}/lib" />
	
		<copy todir="${target-dir}/doc">
			<fileset dir="doc"/>
 		</copy>

		<copy todir="${target-dir}/doc">
			<fileset dir="doc"/>
 		</copy>
		<copy todir="${target-dir}/conf">
			<fileset dir="conf"/>
 		</copy>

		<copy todir="${target-dir}/license">
			<fileset dir="../license"/>
 		</copy>

		<copy todir="${target-dir}/jvm15">
			<fileset dir="../bindings/xml/java/jvm15"/>
 		</copy>

		<copy todir="${target-dir}/clients">
			<fileset dir="../clients" excludes="**/.*"/>
 		</copy>

		<copy todir="${target-dir}">
			<fileset dir="${project.location}">
				<include name="*.sh"/>
				<include name="*.bat"/>
			</fileset>
		</copy>

		<chmod dir="${target-dir}" perm="+x" includes="*.sh"/>
	</target>

	<target name="tarball" depends="build-dist">
		<tar tarfile="../sapo-broker.tar" >
			<tarfileset dir="${target-dir}" prefix="sapo-broker">
				<exclude name="**/*.sh"/>
			</tarfileset>
			<tarfileset dir="${target-dir}" prefix="sapo-broker" filemode="755">
				<include name="**/*.sh"/>
			</tarfileset>
		</tar>
		<gzip src="../sapo-broker.tar" destfile="../sapo-broker.tar.gz" />
		<delete file="../sapo-broker.tar" />
		<delete dir="${target-dir}" />
	</target>

</project>
